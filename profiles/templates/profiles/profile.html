{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'profiles/css/profile.css' %}">
    <link rel="stylesheet" type="text/css" href="https://res.cloudinary.com/dwhennrjl/raw/upload/v1685971817/static/profiles/css/profile.652147a13ad2.css">
{% endblock %}

{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock %}

{% block content %}

    <!--Page Header-->
    <div class="texture rounded m-3">
        <div class="xanthous">
            <h2 class="logo-font start-font moonstone-text section-heading m-2 p-2 mb-4 d-flex justify-content-center">
                My Profile
            </h2>
        </div>
    </div>

    <!--Body Content for Profile Page-->
    <div class="container-fluid xanthous">

        <!--Avatar creation section / Avatar Display-->
        <div class="pt-2">
            {% if avatar %}
                {% if request.user.is_authenticated and avatar.user == request.user %}
                <div class="row">
                    <a class="d-flex justify-content-center avatar-on-profile" href="{% url 'edit_avatar' %}">
                        <div class="image-container">
                            {% if avatar.image %}
                                <img class="card-img-top img-fluid avatar-large" src="{{ avatar.image.url }}" alt="{{ avatar.avatar_name }}'s Avatar">
                            {% else %}
                                <img class="card-img-top img-fluid" src="{{ MEDIA_URL }}noimage.png" alt="{{ avatar.avatar_name }}'s Avatar">
                            {% endif %}
                        </div>
                    </a>                 
                    <div class="float-left mt-0">
                        <a class="d-flex justify-content-center m-2 p-2" href="{% url 'edit_avatar' %}">
                            <h3>
                                <strong>{{ avatar.avatar_name }}</strong>
                            </h3>
                        </a>
                    </div>
                </div>                
                {% endif %}
            {% else %}                        
                {% if request.user.is_authenticated %}
                <h5 class="d-flex align-items-center butterscotch justify-content-center m-0 p-2 text-nowrap">
                    <strong>Create an Avatar for your Profile</strong>
                </h5>

                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-center">
                        <div id="avatar-creation-form">
                            <form method="POST" class="form mb-2" enctype="multipart/form-data">
                                {% csrf_token %}
                                {{ avatar_form|crispy }}
                                <div class="text-center">
                                    <button class="btn onyx-text" type="submit">
                                        <i class="fa-solid fa-user-shield"></i>
                                        <br>
                                        <p>Begin!</p>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}                
        </div>
                   
        <!--The Section Options-->
        <div class="white-text row pb-0 text-uppercase mb-3">
            <div class="col-4 delivery-section-toggle orange white-text pt-3 text-nowrap d-flex align-items-center justify-content-center" data-section="delivery-info">
                <p>Delivery Info</p>
            </div>
            <div class="col-4 review-section-toggle orange white-text pt-3 d-flex align-items-center justify-content-center" data-section="product-reviews">
                <p>Reviews</p>
            </div>
            <div class="col-4 order-section-toggle orange white-text pt-3 text-nowrap d-flex align-items-center justify-content-center" data-section="order-history">
                <p>Order History</p>
            </div>
        </div>

        <!--Review Section-->
        <div class="col-12 big-bottom" id="review-section">
            <h3 class="orange-text">Your Product Reviews</h3>

            <div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body moonstone rounded">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                {% for review in reviews %}
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
                        <div class="moonstone review-element p-2 m-1 rounded" data-review-id="{{ review.id }}" data-review-body="{{ review.body }}">
                            <div class="d-flex justify-content-center">
                                <a class="white-text" href="{% url 'product_detail' review.product.id %}">
                                    {{ review.product }}
                                </a>
                            </div>
                            <hr>
                            <small class="col text-right float-right">{{ review.created_at|date:"F d, Y" }}</small>

                            {% with rating=ratings|get_item:review.product.id %}
                                {% if rating %}
                                <p>Your rating:
                                    {% if rating.rating == 1 %}
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star"></i>
                                    {% elif rating.rating == 2 %}
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star"></i>
                                    {% elif rating.rating == 3 %}
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="far fa-star mr-1"></i>
                                        <i class="far fa-star"></i>
                                    {% elif rating.rating == 4 %}
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="far fa-star"></i>
                                    {% elif rating.rating == 5 %}
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star mr-1"></i>
                                        <i class="fas fa-star"></i>
                                    {% endif %}
                                </p>                                                                       
                                {% endif %}
                            {% endwith %}
                            <p class="xanthous-text"><strong>{{ review.title }}</strong></p>
                            <small class="text-nowrap text-muted">click to see details</small>
                            <div>
                                <a class="white-text rounded pink float-right pl-1 pr-1" href="{% url 'delete_review' review.id %}">
                                    delete
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!--Delivery Section-->
        <div class="col-12 big-bottom" id="delivery-section">
            <div class="col-12 col-lg-6">
                <h3 class="orange-text text-nowrap">Delivery Information</h3>
                <form class="mt-3" action="{% url 'profile' %}" method="POST" id="profile-update-form">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <button class="btn white-text pink rounded text-uppercase float-right">Update Information</button>
                </form>
            </div>
        </div>

        <!--Order Section-->
        <div class="col-12 big-bottom" id="order-section">
            <div class="col-12 col-lg-6">
                <h3 class="orange-text">Order History</h3>
                <div class="order-history table-responsive">
                    <table class="table table-sn table-borderless">
                        <thread>
                            <tr>
                                <th>Order Number</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Order Total</th>
                            </tr>
                        </thread>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <a href="{% url 'order_history' order.order_number %}"
                                    title="{{ order.order_number}}">
                                    {{ order.order_number|truncatechars:6 }}
                                    </a>
                                </td>
                                <td>{{ order.date }}</td>
                                <td>
                                    <ul class="listed-unstyled">
                                        {% for item in order.lineitems.all %}
                                            <li class="small">
                                                {% if item.product.has_variants %}
                                                    Console {{ item.product.variant|upper }}
                                                {% endif %}{{ item.product.name }} x{{ item.quantity }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td>â‚¬{{ order.grand_total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block postloadjs %}
    {{ block.super }}

    <!--Script for avatar form image file selection-->
    <script type="text/javascript">
        $('#new-image').change(function() {
            var file = $('#new-image')[0].files[0];
            $('#filename').text(`Image will be set to: ${file.name}`);
        });

    </script>

    <!--Script to open reviews in more detail on click-->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get all review elements
        const reviewElements = document.querySelectorAll('.review-element');

        // Add a click event listener to each review element
        reviewElements.forEach(reviewElement => {
            reviewElement.addEventListener('click', function () {
                // Get the review ID from the data attribute
                const reviewId = this.dataset.reviewId;

                // Fetch the review modal content
                fetch(`review_modal/${reviewId}/`)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(function(html) {
                        // Update the modal's body with the fetched review content
                        const modalBody = document.querySelector('#reviewModal .modal-body');
                        modalBody.innerHTML = html;

                        // Show the modal
                        $('#reviewModal').modal('show');
                    })
                    .catch(function(error) {
                        console.error('Error fetching review modal content:', error);
                    });
            });
        });
    });
    </script>

    <!--Section toggle functionality-->
    {% include 'profiles/includes/profiles-sections-toggle-logic.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="{% static 'profiles/js/countryfield.js' %}"></script>
    <script type="text/javascript" src="https://res.cloudinary.com/dwhennrjl/raw/upload/v1685971818/static/profiles/js/countryfield.242381779a53.js"></script>
{% endblock %}